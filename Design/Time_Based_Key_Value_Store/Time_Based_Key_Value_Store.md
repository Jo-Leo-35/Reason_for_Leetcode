### LC 981. Time Based Key-Value Store å­¸ç¿’ç­†è¨˜

---

#### 1. é¡Œç›®æ•˜è¿°èˆ‡æŠ½è±¡æ¦‚å¿µ (Description & Abstraction)

*   **é¡Œç›®æ•˜è¿°**ï¼š
    è¨­è¨ˆä¸€å€‹ Key-Value å„²å­˜ç³»çµ±ï¼Œæ”¯æ´å…©å€‹æ“ä½œï¼š
    *   `set(key, value, timestamp)`: åœ¨ç‰¹å®šæ™‚é–“é» `timestamp` å„²å­˜ `key` çš„ `value`ã€‚
    *   `get(key, timestamp)`: å›å‚³è©² `key` åœ¨ `timestamp` ç•¶ä¸‹æˆ–ä¹‹å‰ (`prev_time <= timestamp`) çš„æœ€æ–° `value`ã€‚å¦‚æœæ²’æœ‰å°æ‡‰æ™‚é–“é»çš„å€¼ï¼Œå›å‚³ç©ºå­—ä¸² `""`ã€‚

*   **æŠ½è±¡æ¦‚å¿µ (The "Aha!" Moment)**ï¼š
    é€™é¡Œå…¶å¯¦æ˜¯åœ¨è€ƒ **ã€Œå¤šç‰ˆæœ¬æ§åˆ¶ (Multi-Version)ã€** çš„è³‡æ–™çµæ§‹ã€‚ä½ å¯ä»¥æŠŠå®ƒæƒ³åƒæˆä¸€å€‹ ã€Œè‚¡ç¥¨åƒ¹æ ¼æŸ¥è©¢ç³»çµ±ã€ æˆ– ã€ŒGit ç‰ˆæœ¬æ§åˆ¶ã€ï¼š
    å¦‚æœæˆ‘åœ¨ $t=1$ å­˜äº† "A"ï¼Œ$t=4$ å­˜äº† "B"ã€‚æŸ¥è©¢ $t=3$ æ™‚ï¼Œå› ç‚º $t=3$ æ²’æœ‰è®Šå‹•ï¼Œç‹€æ…‹æ‡‰è©²å»¶çºŒ $t=1$ çš„ "A"ã€‚
    é€™åœ¨æ•¸å­¸ä¸Šç­‰æ–¼å°‹æ‰¾ **Floor Key** (å°æ–¼ç­‰æ–¼ç›®æ¨™å€¼çš„æœ€å¤§å€¼)ã€‚

*   **é¡Œå‹æ¨™ç±¤ (Tags)**ï¼š`Hash Map`, `Binary Search`, `Design`

---

#### 2. ç®—æ³•æ¯”è¼ƒ (Algorithm Comparison)

é€™é¡Œçš„é—œéµåœ¨æ–¼å¦‚ä½•å¿«é€Ÿæ‰¾åˆ°ã€Œéå»æœ€è¿‘çš„æ™‚é–“é»ã€ã€‚

| æ–¹æ³• | Set æ™‚é–“è¤‡é›œåº¦ | Get æ™‚é–“è¤‡é›œåº¦ | ç©ºé–“è¤‡é›œåº¦ | é©ç”¨å ´æ™¯ | å‚™è¨» |
| :--- | :--- | :--- | :--- | :--- | :--- |
| **æš´åŠ›è§£ (Linear Scan)** | $O(1)$ | $O(N)$ | $O(N)$ | $N$ å¾ˆå°æ™‚ | æ¯æ¬¡ get éƒ½å¾é ­æƒæï¼Œéš¨è‘—æ­·å²è³‡æ–™å¢åŠ æœƒè®Šæ…¢ (TLE)ã€‚ |
| **Google Standard (Hash Map + BS)** | $O(1)$ | $O(\log N)$ | $O(N)$ | ä¸€èˆ¬é¢è©¦æ¨è–¦ | åˆ©ç”¨é¡Œç›®ç‰¹æ€§ (timestamp éå¢)ï¼Œå­˜å…¥å³æœ‰åºï¼Œå¯ç”¨äºŒåˆ†æœã€‚ |
| **å¹³è¡¡äºŒå…ƒæ¨¹ (TreeMap / BST)** | $O(\log N)$ | $O(\log N)$ | $O(N)$ | Timestamp äº‚åºæ™‚ | å¦‚æœ set çš„æ™‚é–“ä¸æ˜¯éå¢çš„ï¼Œé€™æ˜¯æœ€ä½³è§£ (Java/C++ å¸¸ç”¨)ã€‚ |

*(è¨»ï¼š$N$ æ˜¯è©² Key ç´¯ç©çš„æ­·å²è³‡æ–™ç­†æ•¸ã€‚)*

---

#### 3. Python å¯¦ä½œç´°ç¯€

é€™å±•ç¤ºäº† Python 3.10+ æœ€å„ªé›…çš„å¯«æ³•ï¼Œä½¿ç”¨äº† `bisect` æ¨¡çµ„çš„ `key` åƒæ•¸ï¼Œä¸éœ€è¦æ‰‹å¯«äºŒåˆ†æœï¼Œä¹Ÿä¸éœ€è¦æ§‹é€ å‡è³‡æ–™ã€‚

```python
import collections
import bisect

class TimeMap:
    def __init__(self):
        self.store = collections.defaultdict(list)

    def set(self, key: str, value: str, timestamp: int) -> None:
        # é¡Œç›®ä¿è­‰: timestamp åš´æ ¼éå¢
        self.store[key].append([timestamp, value])

    def get(self, key: str, timestamp: int) -> str:
        if key not in self.store:
            return ""
        
        values = self.store[key]
        # Binary Search (Upper Bound)
        # å°‹æ‰¾ç¬¬ä¸€å€‹ "å¤§æ–¼" timestamp çš„ä½ç½®
        i = bisect.bisect_right(values, timestamp, key=lambda x: x[0])
        
        if i == 0:
            return ""
        
        return values[i - 1][1]
```

---

#### 4. å¾®ç³»çµ±è¨­è¨ˆæ‡‰ç”¨ (Micro-System Design)

åœ¨çœŸå¯¦çš„ç³»çµ±è¨­è¨ˆé¢è©¦ä¸­ï¼Œé€™é¡Œçš„æ ¸å¿ƒæ¦‚å¿µå¯ä»¥ç”¨åœ¨ä»€éº¼åœ°æ–¹ï¼Ÿ

*   **MVCC (Multi-Version Concurrency Control) è³‡æ–™åº«**:
    åƒ PostgreSQL æˆ– MySQL (InnoDB) ç‚ºäº†æ”¯æ´é«˜ä½µç™¼è®€å¯«ï¼Œæœƒä¿ç•™è³‡æ–™çš„èˆŠç‰ˆæœ¬ã€‚ç•¶ä¸€å€‹äº‹å‹™ (Transaction) åœ¨æ™‚é–“ $T$ é–‹å§‹è®€å–æ™‚ï¼Œå®ƒåªèƒ½çœ‹åˆ°æ™‚é–“ $T$ ä¹‹å‰çš„è³‡æ–™å¿«ç…§ (Snapshot)ï¼Œé€™å°±æ˜¯ `get(key, T)` çš„é‚è¼¯ã€‚
*   **é…ç½®ç®¡ç†ä¸­å¿ƒ (Configuration Management)**:
    ç³»çµ±è¨­å®šæª”å¯èƒ½æœƒéš¨æ™‚é–“æ”¹è®Šã€‚ç¶­é‹äººå“¡å¯èƒ½æœƒå•ï¼šã€Œæ˜¨å¤©ä¸‹åˆ 2:00 çš„æ™‚å€™ï¼Œä¼ºæœå™¨çš„ `Max_Connection` è¨­å®šæ˜¯å¤šå°‘ï¼Ÿã€é€™éœ€è¦ä¸€å€‹ Time-Based KV Store ä¾†å›æº¯æ­·å²è¨­å®šã€‚
*   **è‚¡ç¥¨ K ç·šåœ– (Time Series Data)**:
    é›–ç„¶é€šå¸¸ç”¨å°ˆé–€çš„ Time Series DB (å¦‚ InfluxDB)ï¼Œä½†æ ¸å¿ƒé‚è¼¯ä¸€æ¨£ï¼šã€Œçµ¦æˆ‘é€™æ”¯è‚¡ç¥¨åœ¨ 10:05:30 ä¹‹å‰çš„æœ€å¾Œä¸€ç­†æˆäº¤åƒ¹ã€ã€‚

---

#### 5. Follow-up Questions (é¢è©¦å»¶ä¼¸é¡Œ)

*   **Q1: å¦‚æœ set æ“ä½œä¸­çš„ timestamp ä¸æ˜¯éå¢çš„ï¼Œæ€éº¼è¾¦ï¼Ÿ**
    *   **å›ç­”**: ç›®å‰çš„ `append` å¯«æ³•æœƒå¤±æ•ˆ (List è®Šç„¡åº)ã€‚
    *   **è§£æ³• A (Read-Heavy)**: åœ¨ set æ™‚ä½¿ç”¨ `bisect.insort` æ’å…¥åˆ°æ­£ç¢ºä½ç½®ï¼Œä¿æŒ List æœ‰åºã€‚set è®Š $O(N)$ï¼Œget ä¿æŒ $O(\log N)$ã€‚
    *   **è§£æ³• B (Write-Heavy)**: set ç›´æ¥ `append` ($O(1)$)ï¼Œä½†åœ¨ get æ™‚æª¢æŸ¥æ˜¯å¦ sortedï¼Œè‹¥å¦å‰‡ sort ($O(N \log N)$)ã€‚
    *   **è§£æ³• C (Balanced)**: æ”¹ç”¨ Java çš„ `TreeMap` æˆ– C++ `std::map` (Balanced BST)ï¼Œset å’Œ get éƒ½æ˜¯ $O(\log N)$ã€‚

*   **Q2: å¦‚æœæ­·å²è³‡æ–™éå¸¸å¤šï¼Œè¨˜æ†¶é«”æ”¾ä¸ä¸‹æ€éº¼è¾¦ï¼Ÿ (System Design)**
    *   **å›ç­”**: 
        *   **æ¸…ç†èˆŠè³‡æ–™ (Retention Policy)**: åªä¿ç•™æœ€è¿‘ N å¤©çš„è³‡æ–™ï¼ŒèˆŠçš„åˆªé™¤æˆ–æ­¸æª”åˆ°å†·å„²å­˜ (S3)ã€‚
        *   **åˆ†æ•£å¼å„²å­˜ (Sharding)**: æ ¹æ“š Key åš Consistent Hashingï¼ŒæŠŠè³‡æ–™åˆ†æ•£åˆ°å¤šå°æ©Ÿå™¨ä¸Šã€‚
        *   **LSM Tree (Log-Structured Merge-tree)**: é€™æ˜¯ NoSQL (å¦‚ Cassandra, RocksDB) çš„åº•å±¤çµæ§‹ï¼Œéå¸¸é©åˆå¯«å…¥å¤šã€ä¸”éœ€è¦æŒ‰æ™‚é–“æŸ¥è©¢çš„å ´æ™¯ã€‚

*   **Q3: ç‚ºä»€éº¼é¸æ“‡ bisect_right è€Œä¸æ˜¯ bisect_leftï¼Ÿ**
    *   **å›ç­”**: é¡Œç›®è¦æ±‚çš„æ˜¯ `prev_time <= timestamp`ã€‚`bisect_right` æœƒå›å‚³ã€Œå¤§æ–¼ timestamp çš„ç¬¬ä¸€å€‹ä½ç½®ã€ã€‚è©²ä½ç½®çš„ **å‰ä¸€å€‹ (index-1)** æ­£å¥½å°±æ˜¯ã€Œå°æ–¼ç­‰æ–¼ timestamp çš„æœ€å¤§å€¼ã€ã€‚å¦‚æœç”¨ `bisect_left`ï¼Œç•¶é‡åˆ°é‡è¤‡ timestamp æˆ–ç²¾ç¢ºå‘½ä¸­æ™‚ï¼Œé‚è¼¯è™•ç†æœƒæ¯”è¼ƒè¤‡é›œã€‚

---

#### ğŸŒŸ ç¸½çµ (Key Takeaways)

1.  **æœ‰åºæ€§æ˜¯é—œéµ**ï¼šåˆ©ç”¨ timestamp éå¢çš„ç‰¹æ€§ï¼ŒæŠŠå•é¡Œè½‰åŒ–ç‚º Binary Searchã€‚
2.  **API ç†Ÿç·´åº¦**ï¼šåœ¨ Python ä¸­ï¼Œ`bisect` æ˜¯è™•ç†æœ‰åºé™£åˆ—çš„ç¥å™¨ï¼Œæ­é… `key` åƒæ•¸å¯è™•ç†è¤‡é›œç‰©ä»¶ã€‚
3.  **é‚Šç•Œè™•ç†**ï¼šæ°¸é è¨˜å¾—æª¢æŸ¥ `i == 0` (æ‰¾ä¸åˆ°æ›´æ—©çš„æ™‚é–“) çš„æƒ…æ³ã€‚
